# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: CI/CD Pipeline

# main ë¸Œëœì¹˜ì— ëŒ€í•œ PRì´ "ë¨¸ì§€ë˜ì–´ closed" ë  ë•Œ ì‹¤í–‰
on:
  pull_request:
    branches:
      - main
    types: [closed]  # PRì´ ë‹¨ìˆœíˆ ë‹«íŒ ê²Œ ì•„ë‹ˆë¼ ë¨¸ì§€ëœ ê²½ìš°ë§Œ íƒ€ê²Ÿ

jobs:
  deploy:
    # ë¨¸ì§€ëœ PRì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest  # GitHub Actionsì—ì„œ ì œê³µí•˜ëŠ” Ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (í•´ë‹¹ ì»¤ë°‹ ê¸°ì¤€ì˜ ì½”ë“œ ë‚´ë ¤ë°›ê¸°)
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. JDK 17 ì„¤ì¹˜ (Spring Boot í”„ë¡œì íŠ¸ì— í•„ìš”)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 17

      # 3. Gradleë¡œ í”„ë¡œì íŠ¸ ë¹Œë“œ (jar ìƒì„±)
      - name: Build with Gradle
        working-directory: ./backend
        run: |
          chmod +x ./gradlew
          ./gradlew build

      # 4. Docker Hub ë¡œê·¸ì¸ (secretsì— ë“±ë¡ëœ ê³„ì •ìœ¼ë¡œ)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Docker image
        working-directory: ./backend
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/xclone:latest .  # ì´ë¯¸ì§€ ë¹Œë“œ
          docker push ${{ secrets.DOCKER_USERNAME }}/xclone:latest       # Docker Hubì— ì—…ë¡œë“œ

      # 6. EC2ì— SSH ì ‘ì† í›„ ë°°í¬ ìˆ˜í–‰
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}       # EC2 í¼ë¸”ë¦­ IP ë˜ëŠ” ë„ë©”ì¸
          username: ${{ secrets.EC2_USER }}   # ex: ubuntu, ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}     # EC2 ì ‘ì†ìš© private key

          # SSH ì ‘ì† í›„ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤
          script: |
            echo "âœ… Pulling latest Docker image..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/xclone:latest     # ìµœì‹  ì´ë¯¸ì§€ ë°›ê¸°

            echo "ğŸ›‘ Stopping existing container..."
            docker stop xclone || true                                   # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ (ì—†ì–´ë„ ì—ëŸ¬ ë¬´ì‹œ)

            echo "ğŸ§¹ Removing old container..."
            docker rm xclone || true                                     # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ (ì—†ì–´ë„ ì—ëŸ¬ ë¬´ì‹œ)

            echo "ğŸš€ Starting new container..."
            docker run -d --name xclone \                                # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
              -p 80:8080 \                                               # í¬íŠ¸ ë§¤í•‘ (EC2 80 â†’ ì»¨í…Œì´ë„ˆ 8080)
              --restart=always \                                         # ì„œë²„ ì¬ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰
              ${{ secrets.DOCKER_USERNAME }}/xclone:latest              # ìµœì‹  ì´ë¯¸ì§€ë¡œ ì‹¤í–‰
